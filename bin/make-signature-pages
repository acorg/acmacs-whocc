#! /usr/bin/env python3
# -*- Python -*-
# ======================================================================

# States
# init, make_seqdb, export_sequences, make_trees_init, make_trees_update_config

import sys, os, json, socket, subprocess, copy
from pathlib import Path
# sys.path[:0] = [str(Path(os.environ["ACMACSD_ROOT"]).resolve().joinpath("py"))]
import logging; module_logger = logging.getLogger(__name__)

# ======================================================================

ROOT_DIR = None
CONFIG = None
STATE_FILE = None

def main(args):
    # if socket.gethostname() != "i19":
    #     raise RuntimeError("The script must be run on i19")
    if not os.getenv("ACMACSD_ROOT") or not Path(os.getenv("ACMACSD_ROOT"), "data", "hidb5.h1.json.xz"):
        raise RuntimeError("ACMACSD_ROOT not set or no hidb in $ACMACSD_ROOT/data")
    global ROOT_DIR, STATE_FILE
    ROOT_DIR = Path("/syn/eu/ac/results/whocc-tree", args.tag)
    STATE_FILE = ROOT_DIR.joinpath("state.json")
    if not ROOT_DIR.exists() or not STATE_FILE.exists():
        initialize()
    run()

# ----------------------------------------------------------------------

def initialize():
    ROOT_DIR.mkdir(parents=True, exist_ok=True)
    ROOT_DIR.joinpath("log").mkdir()
    state = {"state": "init", "tree_maker": "week", "tree_maker?": ["week", "day"], "subtypes": ["H1", "H3", "BV", "BY"]}
    save_state(state)

# ----------------------------------------------------------------------

def run():
    global CONFIG
    CONFIG = json.load(Path(os.getenv("ACMACSD_ROOT"), "sources", "acmacs-whocc", "conf", "make-signature-pages.config.json").open("r"))
    state = load_state()
    while True:
        current_state = state["state"]
        globals()["state_" + current_state](state)
        save_state(state)
        if current_state == state["state"]:
            raise RuntimeError("state not changed from " + current_state)

# ----------------------------------------------------------------------

def state_init(state):
    if not ROOT_DIR.joinpath("seqdb.json.xz").exists():
        state["state"] = "make_seqdb"
    else:
        raise NotImplementedError()

# ----------------------------------------------------------------------

def state_make_seqdb(state):
    module_logger.info("making seqdb (~7min)")
    cmd = [
        os.path.expandvars("${ACMACSD_ROOT}/bin/seqdb-create"),
        "--db", ROOT_DIR.joinpath("seqdb.json.xz"),
        "--match-hidb", "--clades",
        os.path.expandvars("${HOME}/ac/tables-store/sequences/*.fas.bz2")
        ]
    subprocess.check_call([str(field) for field in cmd], stdout=ROOT_DIR.joinpath("log", "seqdb-create.log").open("w"), stderr=subprocess.STDOUT)
    state["state"] = "export_sequences"

# ----------------------------------------------------------------------

sSeqdbExportFlu = {"H1": "h1", "H3": "h3", "BV": "bvic", "BY": "byam"}

def state_export_sequences(state):
    log = ROOT_DIR.joinpath("log", "seqdb-export.log").open("w")
    for subtype in state["subtypes"]:
        output_dir = ROOT_DIR.joinpath("tree-maker", subtype)
        output_dir.mkdir(parents=True, exist_ok=True)
        module_logger.info("exporting fasta for %s", subtype)
        cmd = [
            os.path.expandvars("${ACMACSD_ROOT}/bin/seqdb-export"),
            "--db", str(ROOT_DIR.joinpath("seqdb.json.xz")),
            "--flu", sSeqdbExportFlu[subtype],
            "--recent", CONFIG[subtype]["sequences"]["recent"],
            "--hamming-distance-threshold", CONFIG[subtype]["sequences"]["hamming_distance_threshold"],
            "--tree-maker",
            "--base-seq", CONFIG[subtype]["sequences"]["base"],
            output_dir.joinpath("source.fas")
            ]
        subprocess.check_call([str(field) for field in cmd], stdout=log, stderr=subprocess.STDOUT)
    state["state"] = "make_trees_init"

# ----------------------------------------------------------------------

def state_make_trees_init(state):
    module_logger.info("initializing tree-maker")
    log = ROOT_DIR.joinpath("log", "tree-maker.log").open("a")
    for subtype in state["subtypes"]:
        output_dir = ROOT_DIR.joinpath("tree-maker", subtype)
        subprocess.check_call([os.path.expandvars("${ACMACSD_ROOT}/bin/tree-maker"), "--dir", str(output_dir), "init"], stdout=log, stderr=subprocess.STDOUT)
    state["state"] = "make_trees_update_config"

# ----------------------------------------------------------------------

def state_make_trees_update_config(state):
    module_logger.info("updating configs for tree-maker")
    for subtype in state["subtypes"]:
        output_dir = ROOT_DIR.joinpath("tree-maker", subtype)
        config_file = output_dir.joinpath("tree-maker.config")
        config = json.load(config_file.open())
        config_file.rename(output_dir.joinpath("tree-maker.orig.config"))
        config.update(CONFIG[subtype]["tree_maker"][state["tree_maker"]])
        json.dump(config, config_file.open("w"), indent=2, sort_keys=True)

# ----------------------------------------------------------------------

# def state_fail(state):
#     raise NotImplementedError("state fail")

# ----------------------------------------------------------------------

def save_state(state):
    json.dump(state, STATE_FILE.open("w"), indent=2)

def load_state():
    return json.load(STATE_FILE.open("r"))

# ----------------------------------------------------------------------

import argparse, traceback

try:
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument('-d', '--debug', action='store_const', dest='loglevel', const=logging.DEBUG, default=logging.INFO, help='Enable debugging output.')
    parser.add_argument('-v', '--verbose', action='store_true', dest='verbose', default=False)
    parser.add_argument('-t', '--tag', action='store', dest='tag', required=True)

    args = parser.parse_args()
    if args.verbose:
        args.loglevel = logging.DEBUG
    logging.basicConfig(level=args.loglevel, format="%(levelname)s %(asctime)s: %(message)s")
    exit_code = main(args)
except Exception as err:
    logging.error('{}\n{}'.format(err, traceback.format_exc()))
    exit_code = 1
exit(exit_code)


# ======================================================================
### Local Variables:
### eval: (if (fboundp 'eu-rename-buffer) (eu-rename-buffer))
### End:
