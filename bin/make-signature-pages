#! /usr/bin/env python3
# -*- Python -*-
# ======================================================================

import sys, os, json, socket
from pathlib import Path
# sys.path[:0] = [str(Path(os.environ["ACMACSD_ROOT"]).resolve().joinpath("py"))]
import logging; module_logger = logging.getLogger(__name__)

# ======================================================================

ROOT_DIR = None

def main(args):
    # if socket.gethostname() != "i19":
    #     raise RuntimeError("The script must be run on i19")
    global ROOT_DIR, STATE_FILE
    ROOT_DIR = Path("/syn/eu/ac/results/whocc-tree", args.tag)
    STATE_FILE = ROOT_DIR.joinpath("state.json")
    if not ROOT_DIR.exists():
        initialize()
    run()

# ----------------------------------------------------------------------

def initialize():
    ROOT_DIR.mkdir(parents=True)
    state = {"state": "init", "subtypes": ["H1", "H3", "BV", "BY"]}
    save_state(state)

# ----------------------------------------------------------------------

def run():
    state = load_state()
    while True:
        globals()["state_" + state["state"]](state)
        save_state(state)

# ----------------------------------------------------------------------

def state_init(state):
    raise NotImplementedError()

# ----------------------------------------------------------------------

def save_state(state):
    json.dump(state, STATE_FILE.open("w"), indent=2)

def load_state():
    return json.load(STATE_FILE.open("r"))

# ----------------------------------------------------------------------

import argparse, traceback

try:
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument('-d', '--debug', action='store_const', dest='loglevel', const=logging.DEBUG, default=logging.INFO, help='Enable debugging output.')
    parser.add_argument('-v', '--verbose', action='store_true', dest='verbose', default=False)
    parser.add_argument('-t', '--tag', action='store', dest='tag', required=True)

    args = parser.parse_args()
    if args.verbose:
        args.loglevel = logging.DEBUG
    logging.basicConfig(level=args.loglevel, format="%(levelname)s %(asctime)s: %(message)s")
    exit_code = main(args)
except Exception as err:
    logging.error('{}\n{}'.format(err, traceback.format_exc()))
    exit_code = 1
exit(exit_code)


# ======================================================================
### Local Variables:
### eval: (if (fboundp 'eu-rename-buffer) (eu-rename-buffer))
### End:
