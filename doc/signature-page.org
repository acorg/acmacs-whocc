Time-stamp: <2019-04-07 09:23:01 eu>
* Gisaid [[file:~/AD/sources/acmacs-whocc/doc/gisaid.org][instructions for downloading sequences from gisaid]] and making seqdb
* Check config
~/AD/sources/acmacs-whocc/conf/make-signature-pages.config.json
* On albertine
** Generate pdfs for individual flu subtypes
#+BEGIN_SRC sh
~/AD/sources/acmacs-whocc/bin/make-signature-pages -t $(date '+%Y-%m%d') -f <h1 h3 bv by> -s <week day>
#+END_SRC
Command above creates directory, submits to condor and then runs in background.
If processing directory exists, program starts again from the last saved state.
Program sends email on completion or failure.
See ../acmacs-whocc/conf/make-signature-pages.config.json
** Generate pdf with all sig pages
* Runtime
T1 - 1 thread
S0 - full time, S1 - --stop-after-seconds 1

|           | 4k           | 5k                 | 6k                 | 7k                | 8k                | 9k                | 10k               | 11k               |
|-----------+--------------+--------------------+--------------------+-------------------+-------------------+-------------------+-------------------+-------------------|
| T1 S0 i22 | 11652s 3.24h | 15106s 4.20h 48704 | 41986s 11.6h 55654 |                   |                   |                   |                   |                   |
|-----------+--------------+--------------------+--------------------+-------------------+-------------------+-------------------+-------------------+-------------------|
| T1 S1 i22 | _4227s 1.17h | _5222s 1.45h 48774 | _7176s _2.0h 55717 | 9116s 2.53h 61643 | 11728s 3.3h 67044 | 13955s 3.9h 71993 | 15486s 4.3h 78198 | 17463s 4.9h 84923 |
|-----------+--------------+--------------------+--------------------+-------------------+-------------------+-------------------+-------------------+-------------------|
| T  S0 i22 |              |                    |                    |                   |                   |                   |                   |                   |
|-----------+--------------+--------------------+--------------------+-------------------+-------------------+-------------------+-------------------+-------------------|
| T  S1 i22 |              |                    |                    |                   |                   |                   |                   |                   |
|-----------+--------------+--------------------+--------------------+-------------------+-------------------+-------------------+-------------------+-------------------|
| T  S0 o16 |              |                    |                    |                   |                   |                   |                   |                   |
|-----------+--------------+--------------------+--------------------+-------------------+-------------------+-------------------+-------------------+-------------------|
| T  S1 o17 |              |                    |                    |                   |                   |                   |                   |                   |
|-----------+--------------+--------------------+--------------------+-------------------+-------------------+-------------------+-------------------+-------------------|

** Custom version raxml with --stop-after-seconds [2019-04-05 Fri]
*** H3 3997 sequences A%28H3N2%29/HAWAII/22/2012__MDCK1, A%28H3N2%29/ONTARIO/RV2886/2018__P1 ... A%28H3N2%29/ANCONA/3/2019__
**** full time --stop-after-seconds 0 no threads
i22: 11652s (03:14:12)
/syn/eu/raxml-acorg/raxmlHPC-oriane -p 13579 -N 1 -s ../source-4k.fas -n 4k-0s-$(date +%m%d-%H%M%S) -m GTRGAMMAI -e 0.001 -o A%28H3N2%29/HAWAII/22/2012__MDCK1 -c 4 -f d --silent --no-seq-check -D
**** --stop-after-seconds 1 no threads
i22: 4227s (01:10:27)
s=8k; /syn/eu/raxml-acorg/raxml-i22-avx --stop-after-seconds 1 -p 13579 -N 1 -s ../source-$s.fas -n $s-1s-$(date +%m%d-%H%M%S) -m GTRGAMMAI -e 0.001 -o A%28H3N2%29/HAWAII/22/2012__MDCK1 -c 4 -f d --silent --no-seq-check -D
**** full time --stop-after-seconds 0, 32 threads (o16, o17)
for k in $(seq 4 11); do /syn/eu/raxml-acorg/raxml-i22-avx-pthreads -p 13579 -N 1 -T 32 -s ../source-${k}k.fas -n ${k}k-0s-T32-${HOSTNAME}-$(date +%m%d-%H%M%S) -m GTRGAMMAI -e 0.001 -o A%28H3N2%29/HAWAII/22/2012__MDCK1 -c 4 -f d --silent --no-seq-check -D; printf "\n\n\n=====================================================================================\n\n\n"; done
**** --stop-after-seconds 1, 32 threads (o16, o17)
for k in $(seq 4 11); do /syn/eu/raxml-acorg/raxml-i22-avx-pthreads -p 13579 --stop-after-seconds 1 -N 1 -T 32 -s ../source-${k}k.fas -n ${k}k-1s-T32-${HOSTNAME}-$(date +%m%d-%H%M%S) -m GTRGAMMAI -e 0.001 -o A%28H3N2%29/HAWAII/22/2012__MDCK1 -c 4 -f d --silent --no-seq-check -D; printf "\n\n\n=====================================================================================\n\n\n"; done
*** H3 5k sequences A%28H3N2%29/HAWAII/22/2012__MDCK1, 
**** full time --stop-after-seconds 0 no threads
i22: 15106s 4.2h 48704
**** --stop-after-seconds 1 no threads
i22: 5222s 1.45h 48774
*** H3 6k sequences A%28H3N2%29/HAWAII/22/2012__MDCK1, 
**** full time --stop-after-seconds 0 no threads
i22: 
**** --stop-after-seconds 1 no threads
i22: 7176s 2h 55717
*** H3 7k sequences A%28H3N2%29/HAWAII/22/2012__MDCK1, 
**** full time --stop-after-seconds 0 no threads
i22: 
**** --stop-after-seconds 1 no threads
i22: 9116s 2.53h 61643
* OLD (before <2018-12-28 Fri>)
Run on albertine ~/AD/sources/acmacs-whocc/bin/make-signature-pages.before-20181228 -t $(date '+%Y-%m%d')
* OLD (before <2018-07-16 Mon>)
** Making tree for the signature page from the WHO CC sequence and HI tables
*** download sequences from gisaid (see GISAID.md) in put it into ~/ac/tables-store/sequences/gisaid-all-20160101-$(date +%Y%m%d).fas.bz2
*** make ~/AD/data/seqdb.json.xz (make sure hidb in ~/AD/data/ are up to date), approximate running time: 5 minutes
         ~/AD/bin/seqdb-update-whocc
*** mkdir $(date +%Y-%m%d-%H%M), copy seqdb
         D=$(date +%Y-%m%d-%H%M) && for V in bvic byam h1 h3; do mkdir /syn/eu/ac/results/whocc-tree/$V/$D; cp ~/AD/data/seqdb.json.xz /syn/eu/ac/results/whocc-tree/$V/$D; done
*** export sequences from ./seqdb.json.xz
**** base-seq. Use ~/AD/bin/seqdb-list --db ./seqdb.json.xz --re <name> to check, if the name below returns just one seq_id

         BVIC: "VICTORIA/830/2013 MDCK2"
         BYAM: "B/CHRISTCHURCH/503/2013 MDCK1" (since 2017-0214) "B/PHUKET/3073/2013 E4/E3" # "CAMBODIA/FSS29374/2014 MDCK1"
         H3:   "HAWAII/22/2012 MDCK"
         H1:   "SWITZERLAND/9772556/2013 SIAT2"
**** start-date
         H3: 20150301 (6686 sequences)
**** recent 4000
**** export command
         env LD_LIBRARY_PATH=$HOME/AD/lib ~/AD/bin/seqdb-export --db ./seqdb.json.xz --flu $VIRUS_TYPE --recent 4000 --hamming-distance-threshold 160 --tree-maker --base-seq $BASE_SEQ $WORKING_DIR/source.fas

         env LD_LIBRARY_PATH=$HOME/AD/lib ~/AD/bin/seqdb-export --db ./seqdb.json.xz --flu h3 --recent 4000 --hamming-distance-threshold 160 --tree-maker --base-seq "HAWAII/22/2012 MDCK" source.fas
         env LD_LIBRARY_PATH=$HOME/AD/lib ~/AD/bin/seqdb-export --db ./seqdb.json.xz --flu h1 --recent 4000 --hamming-distance-threshold 160 --tree-maker --base-seq "SWITZERLAND/9772556/2013 SIAT2" source.fas
         env LD_LIBRARY_PATH=$HOME/AD/lib ~/AD/bin/seqdb-export --db ./seqdb.json.xz --flu bvic --recent 4000 --hamming-distance-threshold 160 --tree-maker --base-seq "VICTORIA/830/2013 MDCK2" source.fas
         env LD_LIBRARY_PATH=$HOME/AD/lib ~/AD/bin/seqdb-export --db ./seqdb.json.xz --flu byam --recent 4000 --hamming-distance-threshold 160 --tree-maker --base-seq "B/CHRISTCHURCH/503/2013 MDCK1" source.fas
*** Initilialize tree maker
         env LD_LIBRARY_PATH=$HOME/AD/lib ~/AD/bin/tree-maker init
*** Edit $WORKING_DIR/tree-maker.config
*** Submit tree maker and wait for completion
         env LD_LIBRARY_PATH=$HOME/AD/lib ~/AD/bin/tree-maker wait
** Drawing tree
*** Init settings
         ~/AD/bin/sigp --seqdb ~/AD/data/seqdb.json.xz --init-settings tree.settings.json tree.json.xz /tmp/tree.pdf && open /tmp/tree.pdf
*** Edit settings in tree.settings.json
*** Generate pdf with the tree
         ~/AD/bin/sigp --seqdb ~/AD/data/seqdb.json.xz -s tree.settings.json tree.json.xz tree.pdf && open tree.pdf
** Signature page
*** Init settings
         ~/AD/bin/sigp --seqdb ~/AD/data/seqdb.json.xz --chart <chart.sdb> --init-settings sigp.settings.json tree.json.xz /tmp/sigp.pdf && open /tmp/sigp.pdf
*** Edit settings in sigp.settings.json
*** Generate pdf with the signature page
         ~/AD/bin/sigp --seqdb ~/AD/data/seqdb.json.xz --chart <chart.sdb> -s sigp.settings.json tree.json.xz sigp.pdf && open sigp.pdf

 # ======================================================================
 ### Local Variables:
 ### eval: (add-hook 'before-save-hook 'time-stamp)
 ### End:
